<!doctype html>
<html><!-- InstanceBegin template="/Templates/DemoTemplate.dwt" codeOutsideHTMLIsLocked="false" -->
<head>
	<meta charset="utf-8">
	<!-- InstanceBeginEditable name="doctitle" -->
	<title>OpenMD Demo - Cheminf-to-web Project</title>
	<!-- InstanceEndEditable -->
	<link href="../../../styles/base.css" rel="stylesheet" type="text/css">	
	
	<link href="../../../styles/default.css" rel="stylesheet" type="text/css">
	
	<link href="../../../styles/demos.css" rel="stylesheet" type="text/css">
	<script src="../../scripts/demoUtils.js"></script>	
	<!-- InstanceBeginEditable name="demoHead" -->
	<script src="controller.js"></script>
	<script>
		window.onload = function()
		{
			fillPredefinedInputDataList($('selPredefinedInputs'));
			$('selPredefinedInputs').onchange = predefinedInputDataListChange;
			
			var omdFilePicker = $('inputOmdFile');
			DemoUtils.assocFilePickerRelatedElems(omdFilePicker, {'contentDisplayer': $('textInputOmd')});
			var incFilePicker = $('inputIncFiles');
			incFilePicker.onchange = function()
			{
				var files = incFilePicker.files;
				addIncFiles(files);
			}
			$('btnClearIncFiles').onclick = clearIncFiles;
			
		}
	</script>
	<!-- InstanceEndEditable -->
	
	
</head>

<body>
	<header class="MainHeader" id="mainHeader">
		<h1 class="HeadTitle">Cheminf-to-web Project</h1>
		<nav class="MainNav" id="mainNav">			
			
			<a id="logo"  href="../../../index.html" title="Project Home"><span>Cheminf-to-web</span></a>
			<a href="../../../index.html">Overview</a>
			<a href="../../index.html" target="_blank">Demos</a>
			<!--
			<a href="../documents/tutorial/index.html" target="_blank">Tutorial</a>
			<a href="../documents/index.html">Documents</a>
			-->
			<a href="../../../download/index.html">Download</a>
			<!-- InstanceBeginEditable name="AdditionalMainNavItems" -->
			<!-- InstanceEndEditable -->			
						
		</nav>
	</header>	
	<section class="MainContent" id="mainContent">    			
		
			<nav class="SideNav">				
				<a href="../../../index.html">Overview</a>
				<a href="../../index.html">Demos</a>
				<!--
				<a href="../documents/tutorial/index.html" target="_blank">Tutorial</a>
				<a href="../documents/index.html">Documents</a>
				-->
				<a href="../../../downloads.html">Download</a>
				<!-- InstanceBeginEditable name="SideNavContent" -->
				<!-- InstanceEndEditable -->						
			</nav>
						
		<article id="mainArticle" class="MainArticle">			
			<header>
				<!-- InstanceBeginEditable name="PossibleGroupSection" -->
				<!-- InstanceEndEditable -->				
				<h1 class="MainTitle" id="mainTitle"><!-- InstanceBeginEditable name="ArticleHeadLine" -->OpenMD Demo<!-- InstanceEndEditable --></h1>
			</header>		
			<!-- InstanceBeginEditable name="MainContent" -->
			<p>Molecular dynamics calculation often requires a lot of time, from minutes to hours, even days. So OpenMD JS library should not be used in the main thread, or it will surely block the web browser UI. Web worker is the ideal circumstance to run OpenMD calculation while data can be transfered between web worker and main thread by message.</p>
			<p>In the main thread JS file, a extra web worker should firstly be created:</p>
			<pre class="CodeBlock">
var openMdWorker = new Worker('worker.js');  // load worker js file and create the OpenMD worker
var result = {};  // stores the calculation result
// Set message handler, response to messages from worker
openMdWorker.onmessage = function(e) {								
	var data = e.data;
	if (data)
	{
		if (data.msgType === 'calculationResult') // worker reports that the calculation is done
		{
			if (data.successful)  // calculation suceeded
			{
				result.report = data.report;  // report data, same as the content of .report file generated by native OpenMD
				result.eor = data.eor  // eor data, same as the content of .eor file generated by native OpenMD
				result.stat = data.stat;  // status data, same as the content of .stat file generated by native OpenMD
				result.dump = data.dump;  // dump data, same as the content of .dump file generated by native OpenMD
			}
			else  // calculation failed
			{
				setStatus('Calculation failed! Please change browser console for the details.');
			}
		}
		else if (data.msgType === 'progress')  // worker reports calculation progress
		{
			var percent = Math.round(data.percentage);
			var remainingTime = data.remainingTime;  // in sec
			var endTime = new Date(Date.now() + remainingTime * 1000);						
			var sStatus = 'Calculating: ' + percent + '% done, estimate ending in ' + endTime.toLocaleString();
			setStatus(sStatus);
		}
		else if (data.msgType === 'log')  // show log messages from worker
		{
			console.log(data.msg);
		}
		else if (data.msgType === 'error')  // show error messages from worker
		{
			console.error(data.msg);
		}
	}
}
</pre>
			<p>In general, native OpenMD program receives a .omd input file while additional data files or force field files can be included in the main input file. In JavaScript aspect, those input data should first be prepared in main thread (e.g. loaded from local file through FileAPI or load from URL by AJAX), converted into string, then be passed to the web worker by message:</p>
			<pre class="CodeBlock">var incContents = [{'fileId': 'alkane.inc', 'content': '...'}];  // prepare include file data
var omdData = '...'; // set source OMD file data
// Transfer include data to worker
openMdWorker.postMessage({'msgType': 'incData', 'incData': JSON.stringify(incFileData)});
// Transfer source OMD data to worker and starts caluclation
openMdWorker.postMessage({'msgType': 'calculate', 'omdData': omdData});</pre>
			<p>Meanwhile, the worker.js should respond to messages from main thread, run the calcualtion job (by instance of wrapper class <span class="InlineCode">OpenMdRunner</span>) and report status of calculation back to main thread:</p>
			<pre class="CodeBlock">importScripts('../../../libs/compiled/openMD.js');  // OpenMD JS lib should be loaded in the worker first
var Module = OpenMdModule();  // create OpenMD module object
var omdData, incData;  // global variable to store source data transfered from main thread

onmessage = function(e)  // message handler, receive messages from main thread<br>{<br>	var data = e.data;<br>	if (data)<br>	{<br>		if (data.msgType === 'incData')  // set include file data<br>		{<br>			incData = JSON.parse(data.incData);			<br>		}<br>		if (data.msgType === 'calculate')	// set main data, begin calculation<br>		{<br>			omdData = data.omdData;<br>			execRunner(); // run the calculation<br>		}<br>	}<br>}

function execRunner()  // function to do the calculation
{
	var runner = new Module.OpenMdRunner();  // create OpenMD calculation runner object
<br>	// prepare include data<br>	if (incData &amp;&amp; incData.length)<br>	{<br>		incData.forEach(function(item){<br>			runner.addIncludeData(item.content, item.fileId);<br>		});<br>	}

	// start calculation
	var success = runner.runOmdJob(omdData);

	// send calculation result back to main thread
	var result = {'msgType': 'calculationResult', 'successful': success};
	if (success)<br>	{<br>		result.report = runner.getReportData();<br>		result.eor = runner.getEorData();<br>		result.stat = runner.getStatData();<br>		result.dump = runner.getDumpData();<br>	}
	postMessage(result);  // post calculation result back to main thread
	runner.delete();  // free runner object
	close();  // close and destroy worker thread
}</pre>
			<p>Live demo: </p>
			<section class="DemoSection">
				<div id="controller">
					<section id="secPredefinedInput" style="border-bottom:1px dotted #ccc;padding:0.5em">
						<label for="selPredefinedInputs">Select a predefined input data: </label>
						<select id="selPredefinedInputs"></select>
						<span>(from OpenMD example files)</span>
					</section>
					<section style="border-bottom:1px dotted #ccc;padding:0.5em">
						<label>Or open local source OMD file: <input type="file" id="inputOmdFile" /></label><br />
						<label>and add include files: <input type="file" id="inputIncFiles" multiple/></label>
						<button id="btnClearIncFiles">Clear inc files</button>	  
					</section>
					<section style="padding:0.5em">
						<button style="font-size:110%" id="btnExec" onclick="execute()">Calculate</button>
						<button style="font-size:110%" id="btnTerminate" onclick="terminate()">Terminate</button>
					</section>
					
					<div id="labelStatus" style="padding: 0.5em;font-weight:bold"></div>	  
					
				</div>
				<div id="stage">
					<fieldset id="secInput">
						<legend>Input Data</legend>
						<label for="textInputOmd">Source OMD data:</label><br />
						<textarea id="textInputOmd" class="DemoBlockTextArea"></textarea><br />
						<label for="textIncFiles">Include files:</label><br />
						<textarea id="textIncFiles" class="DemoBlockTextArea" readonly style="height:4em"></textarea><br />
					</fieldset>	  
					<fieldset id="secOutput">
						<legend>Calculation Result</legend>
						<label for="textReport">Report:</label><br />
						<textarea id="textReport" class="DemoBlockTextArea"></textarea><br />
					
						<label for="textEor">EOR:</label><br />
						<textarea id="textEor" class="DemoBlockTextArea"></textarea><br />
							
						<label for="textStat">Stat:</label><br />
						<textarea id="textStat" class="DemoBlockTextArea"></textarea><br />
					</fieldset>
				</article>
			</div>
			<!-- InstanceEndEditable -->
		</article>
	</section>
	<footer class="MainFooter" id="mainFooter">
		<span>Copyright 2017 Kekule.js Lab</span>
	</footer>
</body>
<!-- InstanceEnd --></html>
